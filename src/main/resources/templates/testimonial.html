<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <title>SGDS - Optimisation</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    
    <!-- Favicon -->
    <link href="img/favicon.ico" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    
    <!-- Libraries Stylesheet -->
    <link href="lib/animate/animate.min.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>

    <!-- Template Stylesheet -->
    <link href="css/style.css" rel="stylesheet">
</head>

<body>
    <div class="container-xxl bg-white p-0">
        <!-- Navbar (contenu existant conservé) -->

        <!-- Section Carte Optimisation -->
        <div class="container-xxl py-5">
            <div class="container">
                <div class="text-center mx-auto mb-5 wow fadeInUp" data-wow-delay="0.1s">
                    <h1 class="mb-3">Optimisation des Trajets</h1>
                    <button id="optimiserBtn" class="btn btn-primary py-3 px-5">Optimiser le trajet</button>
                </div>
                <div id="map" style="height: 600px; border-radius: 15px;"></div>
            </div>
        </div>

        <!-- Footer (contenu existant conservé) -->
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="lib/wow/wow.min.js"></script>
    <script src="lib/easing/easing.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <!-- Script Principal -->
    <script>
        let map;
        let clients = [];
        let currentRoute = null;

        // Initialisation de la carte
        function initMap() {
            map = L.map('map').setView([6.3728, 2.3542], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            loadClients();
        }

        // Chargement des clients
        async function loadClients() {
            try {
                const response = await axios.get('/api/utilisateurs/clients');
                console.log("Clients chargés:", response.data); // Ajoutez ce log pour vérifier les données
                clients = response.data.filter(c => 
                    c.latitude !== null && 
                    c.longitude !== null
                );
                updateMap();
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        // Mise à jour de la carte
        function updateMap() {
            // Nettoyage
            map.eachLayer(layer => {
                if(layer instanceof L.Marker || layer instanceof L.Polyline) {
                    map.removeLayer(layer);
                }
            });

            // Ajout des marqueurs
            clients.forEach(client => {
                L.marker([client.latitude, client.longitude])
                    .bindPopup(`${client.nom}<br>Lat: ${client.latitude}<br>Lon: ${client.longitude}`)
                    .addTo(map);
            });
        }

        // Gestionnaire d'optimisation
        document.getElementById('optimiserBtn').addEventListener('click', async () => {
            if(clients.length < 2) {
                alert("Minimum 2 clients requis !");
                return;
            }

            try {
                const coords = clients.map(c => `${c.longitude},${c.latitude}`).join(';');
                const response = await axios.get(
                    `https://router.project-osrm.org/route/v1/driving/${coords}?overview=full`
                );

                const routeData = response.data.routes[0].geometry.coordinates
                    .map(coord => [coord[1], coord[0]]);

                if(currentRoute) map.removeLayer(currentRoute);
                
                currentRoute = L.polyline(routeData, {
                    color: '#FF6B6B',
                    weight: 5,
                    lineJoin: 'round'
                }).addTo(map);

                map.fitBounds(currentRoute.getBounds());

            } catch (error) {
                console.error("Erreur OSRM:", error);
                alert("Erreur de calcul d'itinéraire");
            }
        });

        // Initialisation
        initMap();
    </script>
</body>
</html>